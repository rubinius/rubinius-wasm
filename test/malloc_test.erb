;; Rubinius WebAssembly VM
;; Copyright (c) 2019, Laurent Julliard and contributors
;; All rights reserved.

(module $malloc_test

  (export "memory" (memory $0))

  <% ['malloc', 'morecore', 'sbrk', 'get_freep', 'set_freep', 'free', 
      'set_hdr_ptr', 'get_hdr_ptr', 'set_hdr_size', 'get_hdr_size'].each do |f| %>
    (export "<%= f %>" (func $<%= f %>))
  <% end %>

  ;; use a small 1 page memory for testing
  <%# render 'memory.wat' %>
  (memory $0 1)

  <%= render 'global.wat' %>
  <%= render 'data.wat' %>
  <%= render 'malloc.wat' %>

  ;; wasmer ruby extension doesn't have the memory.size entry point
  (func $memory_size (result i32)
    (return (memory.size))
  )
  (export "memory_size" (func $memory_size))

  ;; access global variables
  (func $global_heap (result i32) (global.get $HEAP))
  (func $global_heap_size (result i32) (global.get $HEAP_SIZE))
  (export "global_heap" (func $global_heap))
  (export "global_heap_size" (func $global_heap_size))

)